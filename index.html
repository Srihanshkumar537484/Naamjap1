<!doctype html>
<html lang="hi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Bhakti Jap — Radha Radha (Mantra + Theme)</title>
<style>
:root{
  --bg:#0b0810; --card:#120712; --gold:#ffd966; --muted:#c7b79a;
  font-family:"Noto Sans", "Poppins", system-ui, sans-serif;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:
  radial-gradient(700px 200px at 10% 10%, #2b0f26, transparent),
  linear-gradient(180deg,#0b0810,#060511); color:#fff;}
.wrap{display:flex;min-height:100vh}
.sidebar{
  width:260px;padding:18px;background:linear-gradient(180deg,#241017,#180a12);
  border-right:1px solid rgba(255,209,102,0.06);overflow:auto;height:100vh;
}
.brand{display:flex;gap:12px;align-items:center;margin-bottom:12px}
.logo{width:56px;height:56px;border-radius:12px;background:conic-gradient(from 90deg,#ffd166,#ffb86b);display:grid;place-items:center;color:#31110a;font-weight:900;font-size:20px}
.title{font-size:18px;color:var(--gold);font-weight:800}
.subtitle{font-size:12px;color:var(--muted)}
.list{margin-top:12px;display:flex;flex-direction:column;gap:10px}
.item{display:flex;gap:10px;align-items:center;padding:10px;border-radius:10px;cursor:pointer;
  background:linear-gradient(180deg,rgba(255,209,102,0.02),transparent);border:1px solid rgba(255,209,102,0.03);}
.item.active{background:linear-gradient(180deg, rgba(255,209,102,0.06), rgba(255,209,102,0.01));border:1px solid rgba(255,209,102,0.12)}
.avatar{width:56px;height:56px;border-radius:10px;display:grid;place-items:center;font-weight:900;font-size:20px;background:radial-gradient(circle at 30% 30%, rgba(255,209,102,0.12), transparent)}
.meta .name{font-weight:800}
.meta .mantra{font-size:12px;color:var(--muted);margin-top:4px}

/* main */
.main{flex:1;padding:26px;display:flex;flex-direction:column;gap:18px}
.header{display:flex;justify-content:space-between;align-items:center}
.h-title{font-size:26px;color:var(--gold);font-weight:900}
.h-sub{color:var(--muted)}
.stage{display:grid;grid-template-columns:1fr 380px;gap:18px;align-items:start}
.card{background:linear-gradient(180deg,#1b0f12,#12070a);padding:22px;border-radius:14px;border:1px solid rgba(255,255,255,0.03);min-height:420px;position:relative;overflow:hidden}
.devimg{width:200px;height:200px;border-radius:16px;display:grid;place-items:center;font-size:56px;font-weight:900;background:radial-gradient(circle at 30% 30%, rgba(255,209,102,0.12), rgba(255,209,102,0.02))}
.bigname{font-size:48px;font-weight:900;margin-top:14px;color:var(--gold);text-shadow:0 0 18px rgba(255,209,102,0.06);cursor:pointer}
.count{font-size:44px;font-weight:900;margin-top:10px}
.jap{margin-top:18px;padding:16px 28px;border-radius:14px;background:linear-gradient(180deg,#ffd166,#f0b31a);color:#120b12;border:0;font-weight:900;cursor:pointer;box-shadow:0 12px 40px rgba(240,179,26,0.12)}
.controls{display:flex;gap:8px;align-items:center;margin-top:10px}
.small{padding:8px 12px;border-radius:10px;border:0;background:rgba(255,255,255,0.03);color:var(--muted);cursor:pointer}

/* mantra panel */
.mantra-panel{padding:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:10px;margin-top:12px;color:var(--muted)}
.mantra-title{font-weight:800;color:var(--gold)}

/* fly text */
.fly{position:absolute;pointer-events:none;font-weight:900;color:var(--gold);text-shadow:0 0 12px rgba(255,209,102,0.12);
  animation:flyUp 1.0s forwards; transform-origin:center;}
@keyframes flyUp{0%{opacity:1;transform:translateY(0) scale(1);}100%{opacity:0;transform:translateY(-220px) scale(1.4) rotate(-6deg);}}

/* small */
.bottom{margin-top:8px;color:var(--muted);font-size:13px}
@media (max-width:980px){
  .stage{grid-template-columns:1fr}
  .sidebar{display:none}
}
</style>
</head>
<body>
<div class="wrap">
  <aside class="sidebar" id="sidebar">
    <div class="brand">
      <div class="logo">ॐ</div>
      <div>
        <div class="title">Bhakti Jap</div>
        <div class="subtitle">Radha Radha • Naam Jap</div>
      </div>
    </div>

    <div style="font-size:13px;color:var(--muted);margin-bottom:8px">Choose a name — then press the big name or JAP to chant. Each click plays that deity's mantra once. Ambient theme is gentle and low (mantra louder).</div>

    <div class="list" id="list"></div>

    <div style="margin-top:16px">
      <div style="font-weight:800;margin-bottom:6px">Audio Options</div>
      <label style="display:block;margin-bottom:6px"><input type="checkbox" id="musicOn" checked> Per-deity soft ambient (ON)</label>
      <label style="display:block;margin-bottom:6px"><input type="checkbox" id="autoLoop"> Auto-loop mantra (optional)</label>
      <div style="margin-top:10px;color:var(--muted);font-size:13px">Auto-loop off → clicking plays mantra once. Clicking a different name stops current mantra immediately.</div>
    </div>
  </aside>

  <main class="main">
    <div class="header">
      <div>
        <div class="h-title">नाम जाप — Bhakti Counter</div>
        <div class="h-sub">Radha Radha is first. Mantra text shows and the same is chanted (computer TTS tuned to human-like). Music is soft and kept low so mantra is clear.</div>
      </div>
      <div>
        <button class="small" id="stopAll">Stop All</button>
      </div>
    </div>

    <div class="stage">
      <section class="card" id="stageLeft">
        <div style="display:flex;flex-direction:column;align-items:center">
          <div class="devimg" id="devImg">र</div>
          <div class="bigname" id="bigName" title="Click to Jap">Radha Radha</div>
          <div class="count" id="count">0</div>
          <button class="jap" id="japBtn">JAP</button>

          <div class="controls">
            <button class="small" id="plus10">+10</button>
            <button class="small" id="plus108">+108</button>
            <button class="small" id="resetItem">Reset This</button>
          </div>

          <div class="mantra-panel" id="mantraPanel" style="width:100%;max-width:680px">
            <div class="mantra-title" id="mantraTitle">राधे राधे</div>
            <div id="mantraText" style="margin-top:8px;color:var(--muted)">राधे राधे</div>
          </div>
        </div>
      </section>

      <aside class="card">
        <div style="font-weight:800">Quick Controls</div>
        <div style="margin-top:12px" class="mantra-panel">
          <div style="font-weight:700;margin-bottom:6px">Add / Remove</div>
          <input id="addName" placeholder="नया नाम जोड़ें (mantra के साथ '|' दें)" style="width:100%;padding:8px;border-radius:8px;border:0;background:rgba(255,255,255,0.02);color:var(--muted)" />
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="small" id="addBtn">Add</button>
            <button class="small" id="removeBtn">Remove Selected</button>
          </div>
          <div style="font-size:12px;color:var(--muted);margin-top:8px">Add format example: <em>Shri Sai|ॐ साईं नमः</em></div>
        </div>

        <div style="margin-top:12px" class="mantra-panel">
          <div style="font-weight:700;margin-bottom:6px">Tips</div>
          <div style="color:var(--muted);font-size:13px">Use SPACE to jap. Toggle Auto-loop if you want continuous chanting (not recommended by default).</div>
        </div>

      </aside>
    </div>

    <div class="bottom">Tip: Mantra voice quality depends on browser/device TTS voices (Chrome/Edge on desktop usually gives best hi-IN voices).</div>
  </main>
</div>

<script>
/* =========================
   Data & Initialization
   =========================*/
const STORAGE_KEY = 'bhakti_jap_final_v1';
// default list (Radha first)
const DEFAULT = [
  {key:'Radha Radha', display:'राधा राधा', mantra:'राधा राधा', avatar:'र'},
  {key:'Radha Radha', display:'राधे राधे', mantra:'राधे राधे', avatar:'र'},
  {key:'Lord Krishna', display:'श्री कृष्ण', mantra:'हरे कृष्ण हरे कृष्ण, कृष्ण कृष्ण हरे हरे', avatar:'क'},
  {key:'Lord Rama', display:'श्री राम', mantra:'ॐ श्री रामाय नमः', avatar:'रा'},
  {key:'Lord Shiva', display:'महादेव', mantra:'ॐ नमः शिवाय', avatar:'श'},
  {key:'Lord Hanuman', display:'हनुमान जी', mantra:'ॐ हनुमते नमः', avatar:'ह'},
  {key:'Maa Durga', display:'माँ दुर्गा', mantra:'ॐ दुं दुर्गायै नमः', avatar:'दु'},
  {key:'Maa Lakshmi', display:'माँ लक्ष्मी', mantra:'ॐ महालक्ष्म्यै नमः', avatar:'ल'},
  {key:'Lord Vishnu', display:'श्री विष्णु', mantra:'ॐ नमो भगवते वासुदेवाय', avatar:'वि'},
  {key:'Lord Ganesha', display:'गणपति', mantra:'ॐ गं गणपतये नमः', avatar:'ग'},
  {key:'Maa Saraswati', display:'सरस्वती माता', mantra:'ॐ ऐं सरस्वत्यै नमः', avatar:'स'},
  {key:'Brahma', display:'ब्रह्मा', mantra:'ॐ', avatar:'ब'}
  
];

let state = loadState();
let selected = state.order && state.order.length ? state.order[0] : DEFAULT[0].key;

/* load / save */
function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw){
      const items = {}; const order = [];
      for(const d of DEFAULT){ items[d.key] = {count:0,display:d.display,mantra:d.mantra,avatar:d.avatar}; order.push(d.key); }
      const s = {items,order};
      localStorage.setItem(STORAGE_KEY, JSON.stringify(s));
      return s;
    }
    return JSON.parse(raw);
  }catch(e){
    console.error(e);
    const items = {}; const order=[];
    for(const d of DEFAULT){ items[d.key] = {count:0,display:d.display,mantra:d.mantra,avatar:d.avatar}; order.push(d.key); }
    return {items,order};
  }
}
function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); window.dispatchEvent(new Event('storage-sync')); }

/* =========================
   Elements
   =========================*/
const listEl = document.getElementById('list');
const bigName = document.getElementById('bigName');
const devImg = document.getElementById('devImg');
const countEl = document.getElementById('count');
const mantraTitle = document.getElementById('mantraTitle');
const mantraText = document.getElementById('mantraText');
const japBtn = document.getElementById('japBtn');
const stageLeft = document.getElementById('stageLeft');

const musicOnChk = document.getElementById('musicOn');
const autoLoopChk = document.getElementById('autoLoop');
const stopAllBtn = document.getElementById('stopAll');

const addNameInput = document.getElementById('addName');
const addBtn = document.getElementById('addBtn');
const removeBtn = document.getElementById('removeBtn');

const plus10 = document.getElementById('plus10');
const plus108 = document.getElementById('plus108');
const resetItem = document.getElementById('resetItem');

/* =========================
   Render list & selection
   =========================*/
function renderList(){
  listEl.innerHTML = '';
  for(const key of state.order){
    const meta = state.items[key];
    const it = document.createElement('div');
    it.className = 'item' + (key===selected ? ' active':'');
    it.onclick = ()=>{ selectKey(key); };
    const avatar = document.createElement('div'); avatar.className='avatar'; avatar.innerHTML = `<div style="font-weight:900">${meta.avatar||key.charAt(0)}</div>`;
    const metaDiv = document.createElement('div'); metaDiv.className='meta';
    metaDiv.innerHTML = `<div class="name">${meta.display||key}</div><div class="mantra">${(meta.mantra||'').split(' / ')[0]}</div>`;
    it.appendChild(avatar); it.appendChild(metaDiv);
    listEl.appendChild(it);
  }
}

function selectKey(key){
  // stop current mantra immediately
  stopChant();
  stopAmbient();
  selected = key;
  // start ambient for selected if musicOn
  if(musicOnChk.checked) startAmbientFor(selected);
  renderSelected();
  renderList();
}

/* =========================
   Render selected info
   =========================*/
function renderSelected(){
  if(!state.items[selected]){
    selected = state.order.length ? state.order[0] : null;
    if(!selected) return;
  }
  const m = state.items[selected];
  bigName.textContent = m.display || selected;
  devImg.textContent = m.avatar || (m.display||selected).charAt(0);
  countEl.textContent = m.count || 0;
  mantraTitle.textContent = m.display || selected;
  mantraText.textContent = m.mantra || '';
}

/* =========================
   Fly animation
   =========================*/
function spawnFly(text){
  const el = document.createElement('div');
  el.className = 'fly';
  el.textContent = text;
  const rect = stageLeft.getBoundingClientRect();
  const startX = rect.left + 20 + Math.random()*(rect.width-40);
  const startY = rect.bottom - 80 + (Math.random()*40-20);
  el.style.left = startX + 'px';
  el.style.top = startY + 'px';
  el.style.fontSize = (16 + Math.random()*14) + 'px';
  document.body.appendChild(el);
  setTimeout(()=> el.remove(), 1000);
}

/* =========================
   Speech (TTS) chanting logic
   - play once per click (unless autoLoop checked)
   - stop previous utterance when new click
   =========================*/
let chantPlaying = false;
let chantInterval = null;

function chooseVoicePreference(){
  // Return a hi-IN or similar voice if available
  const voices = window.speechSynthesis.getVoices() || [];
  // prefer natural sounding voices when possible by name / lang hints
  const prefer = ['hi-IN','hi','Hindi','Aditi','Kumar','Google हिन्दी','Google Hindi','Lekha','Vidhya'];
  for(const p of prefer){
    const v = voices.find(vo=> (vo.lang && vo.lang.toLowerCase().includes(String(p).toLowerCase())) || (vo.name && vo.name.toLowerCase().includes(String(p).toLowerCase())));
    if(v) return v;
  }
  // fallback: any English voice if no Hindi present
  return voices.find(v=>/en/.test(v.lang)) || voices[0] || null;
}

function speakOnce(text){
  if(!('speechSynthesis' in window)) return console.warn('TTS not supported');
  // stop previous
  stopChant();
  const u = new SpeechSynthesisUtterance(text);
  u.lang = 'hi-IN';
  u.rate = 0.98;
  u.pitch = 0.98;
  const v = chooseVoicePreference();
  if(v) u.voice = v;
  // ensure clear: slightly louder (browser handles volume)
  window.speechSynthesis.speak(u);
  chantPlaying = true;
  u.onend = ()=> { chantPlaying = false; };
}

function startChantLoop(text){
  stopChant();
  chantPlaying = true;
  speakOnce(text);
  // set interval based on text length (approx)
  const approxDur = Math.max(900, text.length * 80);
  chantInterval = setInterval(()=> speakOnce(text), approxDur + 250);
}

function stopChant(){
  chantPlaying = false;
  if(chantInterval){ clearInterval(chantInterval); chantInterval = null; }
  try{ window.speechSynthesis.cancel(); }catch(e){}
}

/* =========================
   Ambient per-deity via WebAudio
   - very soft gain so mantra remains clear
   - when switching deity, stop previous ambient and start new one
   =========================*/
const AudioCtx = window.AudioContext || window.webkitAudioContext;
let audioCtx = null;
let bgNodes = null;

function ensureAudio(){
  if(!audioCtx) audioCtx = new AudioCtx();
}

const AMBIENT_MAP = {
  'Radha Radha': 220,
  'Lord Krishna': 196,
  'Lord Rama': 174,
  'Lord Shiva': 110,
  'Lord Hanuman': 140,
  'Maa Durga': 164,
  'Maa Lakshmi': 210,
  'Lord Vishnu': 180,
  'Lord Ganesha': 150,
  'Maa Saraswati': 240,
  'Brahma': 130
};

function startAmbientFor(key){
  stopAmbient();
  if(!musicOnChk.checked) return;
  ensureAudio();
  const freq = AMBIENT_MAP[key] || 180;
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  const filter = audioCtx.createBiquadFilter();
  // background drone parameters chosen lightweight (Balance B: mantra clear)
  osc.type = 'sine';
  osc.frequency.value = freq;
  filter.type = 'lowpass'; filter.frequency.value = 1200;
  gain.gain.value = 0.0012; // very low
  // subtle LFO for movement
  const lfo = audioCtx.createOscillator();
  const lfoGain = audioCtx.createGain();
  lfo.frequency.value = 0.05 + Math.random()*0.05;
  lfoGain.gain.value = 6;
  lfo.connect(lfoGain);
  lfoGain.connect(osc.frequency);
  osc.connect(filter);
  filter.connect(gain);
  gain.connect(audioCtx.destination);
  osc.start();
  lfo.start();
  bgNodes = {osc,lfo,gain,filter};
}

function stopAmbient(){
  if(!bgNodes) return;
  try{
    bgNodes.osc.stop(); bgNodes.osc.disconnect();
    bgNodes.lfo.stop(); bgNodes.lfo.disconnect();
    bgNodes.gain.disconnect(); bgNodes.filter.disconnect();
  }catch(e){}
  bgNodes = null;
}

/* =========================
   JAP action: play mantra once or start loop (based on autoLoop)
   - clicking different deity stops previous sounds and ambient switches
   =========================*/
function jap(times=1){
  if(!selected) return;
  // stop previous single utterance
  stopChant();
  // increment counts & spawn flies
  for(let i=0;i<times;i++){
    state.items[selected].count = (state.items[selected].count||0) + 1;
    spawnFly(state.items[selected].display || selected);
  }
  saveState();
  renderSelected();
  const mantra = state.items[selected].mantra || state.items[selected].display || selected;
  // speak once or loop based on setting
  if(autoLoopChk.checked){
    startChantLoop(mantra);
  } else {
    speakOnce(mantra);
  }
  // ensure ambient for selected is active if musicOn
  if(musicOnChk.checked) startAmbientFor(selected);
}

/* =========================
   UI wiring
   =========================*/
japBtn.addEventListener('click', ()=> jap(1));
bigName.addEventListener('click', ()=> jap(1));
window.addEventListener('keydown', (e)=>{ if(e.code==='Space' && !['INPUT','TEXTAREA'].includes(document.activeElement.tagName)){ e.preventDefault(); jap(1); } });

plus10.addEventListener('click', ()=> jap(10));
plus108.addEventListener('click', ()=> jap(108));

resetItem.addEventListener('click', ()=>{
  if(!selected) return;
  if(confirm(`Reset ${selected} ka count?`)){
    state.items[selected].count = 0; saveState(); renderSelected();
  }
});

stopAllBtn.addEventListener('click', ()=> { stopChant(); stopAmbient(); });

addBtn.addEventListener('click', ()=>{
  const v = (addNameInput.value||'').trim();
  if(!v) return alert('Naam daalein');
  // optional format: "Name|Mantra"
  let name = v, mantra = v, avatar = v.charAt(0);
  if(v.includes('|')){
    const parts = v.split('|');
    name = parts[0].trim();
    mantra = parts[1].trim();
  }
  if(state.items[name]) return alert('Pehele se maujood hai');
  state.items[name] = {count:0,display:name,mantra:mantra,avatar:avatar};
  state.order.unshift(name); selected = name; saveState(); renderList(); renderSelected(); addNameInput.value='';
});

removeBtn.addEventListener('click', ()=>{
  if(!selected) return;
  if(!confirm(`Remove ${selected} from list?`)) return;
  delete state.items[selected];
  state.order = state.order.filter(x=>x!==selected);
  selected = state.order[0] || null;
  saveState(); renderList(); renderSelected();
});

musicOnChk.addEventListener('change', ()=>{
  if(musicOnChk.checked) startAmbientFor(selected); else stopAmbient();
});
autoLoopChk.addEventListener('change', ()=> { if(!autoLoopChk.checked) stopChant(); });

/* storage sync */
window.addEventListener('storage', (ev)=>{ if(ev.key===STORAGE_KEY){ try{ state = JSON.parse(ev.newValue); renderList(); renderSelected(); }catch(e){} }});
window.addEventListener('storage-sync', ()=>{ const raw = localStorage.getItem(STORAGE_KEY); if(raw) state = JSON.parse(raw); renderList(); renderSelected(); });

/* =========================
   Init render
   =========================*/
if(!state.order) state.order = Object.keys(state.items);
function renderAll(){ renderList(); renderSelected(); }
renderAll();
// start ambient for initial if enabled
if(musicOnChk.checked) startAmbientFor(selected);

// ensure voices load (some browsers require user gesture first)
if(window.speechSynthesis) window.speechSynthesis.onvoiceschanged = ()=>{/* no-op to ensure voice list populates */};

/* small safety: save before unload */
window.addEventListener('beforeunload', ()=> saveState());

/* =========================
   Helper: stop all (used on selection)
   =========================*/
function stopAllNow(){ stopChant(); stopAmbient(); }
</script>
</body>
</html>
